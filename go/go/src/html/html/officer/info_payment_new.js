var g_bill_key_exist,g_membership_fee_status;function getUsingPlanInfo(){API.load({url:CONST.API.MEMBERSHIP.DETAIL,type:CONST.API_TYPE.GET,success:function(t){g_bill_key_exist=t.value.bill_key_exist,g_membership_fee_status=t.value.membership_fee_status,t.value.bill_key_exist||$("#btn_changeBillKey").css("display","none");var e=$("#auto_div").clone(!0),a=$("#manual_div").clone(!0);if($(".auto_div").remove(),$(".manual_div").remove(),0==t.value.membership_fee_status)$("#using_box").css("display","none"),null==t.value.payment_info?($("#amount_used").text("-"),$("#pay_date_used").text("-"),$("#method_used").text("-"),$("#auto_flag_used").text(""),$(".btn_pay_change").css("display","none")):($("#amount_used").text(setComma(t.value.payment_info.amount)+" 원"),$("#pay_date_used").text(moment(t.value.payment_info.auth_date,"YY-MM-DD hh:mm:ss").format("YYYY-MM-DD hh:mm:ss")),1==t.value.payment_info.order_type?$("#auto_flag_used").text("( 직접 결제 )"):$("#auto_flag_used").text("( 자동 결제 )"),1==t.value.payment_setting?($(".current_pay").after(a),$(".changing_pay").after(e)):2==t.value.payment_setting&&($(".current_pay").after(e),$(".changing_pay").after(a)));else{$("#used_box").css("display","none"),$("#name_using").text(t.value.use_membership_name);let n=getDttm(t.value.membership_payment_date).dt,i=getDateByStr(n),s=moment(i).add("1","M").format("YYYY-MM"),l=moment(s).add("11","M").format("YYYY-MM"),r=l+"-"+moment(l).startOf("month").daysInMonth();$("#start_using").text(n),$("#end_using").text(r);let o=getDateDiffWith10(r,getToDay().dt);if($("#until_using").text(`(만료 ${o}일전)`),Number(o)>30?($("#end_using, #until_using").removeClass("red"),$("#btn_cart").css("display","none"),$("#expired_li").css("display","none")):$("#normal_li").css("display","none"),""==t.value.default_free_start||""==t.value.default_free_end?$("#free_using_default_li").css("display","none"):($("#free_start_using_default").text(t.value.default_free_start),$("#free_end_using_default").text(t.value.default_free_end)),""==t.value.add_free_start||""==t.value.add_free_end?$("#free_using_extra_li").css("display","none"):($("#free_start_using_extra").text(t.value.add_free_start),$("#free_end_using_extra").text(t.value.add_free_end)),$("#count_using").text(t.value.this_month_service_count),$("#total_using").text(t.value.usage_limit),9999==t.value.usage_limit&&(t.value.usage_limit="무제한",$("#limit_using").text(t.value.usage_limit)),null==t.value.payment_info)$("#amount_using").text("-"),$("#pay_date_using").text("-"),$("#method_using").text("-"),$("#auto_flag_using").text(""),$(".btn_pay_change").css("display","none");else{$("#amount_using").text(setComma(t.value.payment_info.amount)+" 원"),$("#pay_date_using").text(moment(t.value.payment_info.auth_date,"YY-MM-DD hh:mm:ss").format("YYYY-MM-DD HH:mm:ss")),1==t.value.payment_info.order_type?$("#auto_flag_using").text("( 직접 결제 )"):$("#auto_flag_using").text("( 자동 결제 )"),1==t.value.payment_setting?($(".current_pay").after(a),$(".changing_pay").after(e)):2==t.value.payment_setting&&($(".current_pay").after(e),$(".changing_pay").after(a)),$("#due_date").text(t.value.payment_due_date),$("#current_plan").text(t.value.use_membership_name);let n=new Date,i=moment(t.value.payment_due_date).subtract("7","day");moment(n)<i&&$("#btn_direct_pay").css("display","none")}}$("#cart_change, #cart, #cart_inuse").find("tbody").empty(),$.each(t.value.plans,(function(e,a){"9999"==a.usage_limit&&(a.usage_limit="무제한"),$("#cart_change").find("tbody").append(`<tr data-planseq="${a.membership_plan[0].product_seq}" class="">\n\t\t\t\t\t<td class="membership_desc">\n\t\t\t\t\t  \x3c!-- 멤버십 명 --\x3e\n\t\t\t\t\t  <i class="far fa-credit-card mRight10"></i><span class="plan_name">${a.name}</span>\n\t\t\t\t\t  \x3c!-- 멤버십 설명 --\x3e\n\t\t\t\t\t  <div class="description">${a.desc_text}</div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="only_showDetail text-right pRight10">\n\t\t\t\t\t  <label class="only_showDetail mBot0">가입비</label>\n\t\t\t\t\t  <div class="membership_price price">${setComma(a.membership_plan[1].discounted_amount)}<span class="fs_12p mLeft5">원</span></div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="text-right pRight10">\n\t\t\t\t\t  <label class="mBot0">월 요금</label>\n\t\t\t\t\t  <div class="plan_price price">${setComma(a.membership_plan[0].discounted_amount)}<span class="fs_12p mLeft5">원</span></div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="only_showDetail text-right pRight10">\n\t\t\t\t\t  <label class="only_showDetail mBot0">월 최대 이용건수</label>\n\t\t\t\t\t  <div class="price">${a.usage_limit} 회</div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="pLeft30">\n\t\t\t\t\t  <button type="button" class="btn btn-primary btn_xxs change_item change_item_${e}" data-toggle="modal" data-target="#change_membership_modal">멤버십 변경하기</button>\n\t\t\t\t\t</td>\n\t\t\t\t  </tr>`);let n="";n=0==g_membership_fee_status?a.membership_plan[1].product_seq:a.membership_plan[0].product_seq,$("#cart").find("tbody").append(`<tr data-planseq="${n}" class="">\n\t\t\t\t\t<td class="membership_desc">\n\t\t\t\t\t  \x3c!-- 멤버십 명 --\x3e\n\t\t\t\t\t  <i class="far fa-credit-card mRight10"></i><span class="plan_name">${a.name}</span>\n\t\t\t\t\t  \x3c!-- 멤버십 설명 --\x3e\n\t\t\t\t\t  <div class="description">${a.desc_text}</div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="only_showDetail text-right pRight10">\n\t\t\t\t\t  <label class="only_showDetail mBot0">가입비</label>\n\t\t\t\t\t  <div class="membership_price price">${setComma(a.membership_plan[1].discounted_amount)}<span class="fs_12p mLeft5">원</span></div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="text-right pRight10">\n\t\t\t\t\t  <label class="mBot0">월 요금</label>\n\t\t\t\t\t  <div class="plan_price price">${setComma(a.membership_plan[0].discounted_amount)}<span class="fs_12p mLeft5">원</span></div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="only_showDetail text-right pRight10">\n\t\t\t\t\t  <label class="only_showDetail mBot0">월 최대 이용건수</label>\n\t\t\t\t\t  <div class="price">${a.usage_limit} 회</div>\n\t\t\t\t\t</td>\n\t\t\t\t\t<td class="pLeft30">\n\t\t\t\t\t  <button type="button" class="btn btn-primary btn_xxs purchase_item">멤버십 결제하기</button>\n\t\t\t\t\t</td>\n\t\t\t\t  </tr>`),1==a.current_use?($(".change_item_"+e).prop("disabled",!0),$(".change_item_"+e).after('<button type="button" class="btn btn-outline-danger btn_xxs mLeft10" data-toggle="modal" data-target="#modal_break_1">멤버십 해지하기</button>'),$(".current_membership").find(".membership_name").text(`${a.name}`),$(".current_membership").find(".description").text(`${a.desc_text}`),$("#cart_inuse").find("tbody").append(`<tr data-planseq="${a.membership_plan[0].product_seq}" class="">\n\t\t\t\t\t\t<td class="membership_desc">\n\t\t\t\t\t\t  \x3c!-- 멤버십 명 --\x3e\n\t\t\t\t\t\t  \x3c!-- 일치하는 멤버십이 있을경우 badge 추가 --\x3e\n\t\t\t\t\t\t  <i class="far fa-credit-card mRight10"></i><span class="plan_name">${t.value.use_membership_name}</span><span class="badge badge-pill badge-danger mLeft10">이용중</span>\n\t\t\t\t\t\t  \x3c!-- 멤버십 설명 --\x3e\n\t\t\t\t\t\t  <div class="description">${a.desc_text}</div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td class="only_showDetail text-right pRight10">\n\t\t\t\t\t\t  <label class="only_showDetail mBot0">가입비</label>\n\t\t\t\t\t\t  <div class="membership_price price">${setComma(a.membership_plan[1].discounted_amount)}<span class="fs_12p mLeft5">원</span></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td class="text-right pRight10">\n\t\t\t\t\t\t  <label class="mBot0">월 요금</label>\n\t\t\t\t\t\t  <div class="plan_price price">${setComma(a.membership_plan[0].discounted_amount)}<span class="fs_12p mLeft5">원</span></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td class="only_showDetail text-right pRight10">\n\t\t\t\t\t\t  <label class="only_showDetail mBot0">월 최대 이용건수</label>\n\t\t\t\t\t\t  <div class="price">${a.usage_limit} 회</span></div>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t\t<td class="pLeft30">\n\t\t\t\t\t\t  <button type="button" class="btn btn-danger btn_xxs purchase_item">멤버십 직접 결제하기</button>\n\t\t\t\t\t\t</td>\n\t\t\t\t\t  </tr>`)):($(".changing_membership").find(".membership_name").text(`${a.name}`),$(".changing_membership").find(".membership_name").attr("data-planseq",`${a.membership_plan[0].product_seq}`),$(".changing_membership").find(".description").text(`${a.desc_text}`))}))},complete:function(t){$("#btn_change").on("click",(function(e){if(e.stopPropagation(),g_bill_key_exist)$("#change_payment_modal").find("#btn_changeBillKey").remove(),$("#change_payment_modal").modal("show");else if(1==t.responseJSON.value.payment_setting){let t=JSON.parse(COMM.getCookie("user_info")).name,e=JSON.parse(COMM.getCookie("user_info")).phoneno,a=JSON.parse(COMM.getCookie("user_info")).email;$("#buyer_name_billing").val(t),$("#buyer_phone_billing").val(e),$("#buyer_email_billing").val(a),$("#modal_billing").modal("show")}else $("#change_payment_modal").find("#btn_changeBillKey").remove(),$("#change_payment_modal").modal("show")})),$("#btn_changeBillKey").on("click",(function(t){t.stopPropagation();let e=JSON.parse(COMM.getCookie("user_info")).name,a=JSON.parse(COMM.getCookie("user_info")).phoneno,n=JSON.parse(COMM.getCookie("user_info")).email;$("#buyer_name_billing").val(e),$("#buyer_phone_billing").val(a),$("#buyer_email_billing").val(n),$("#modal_billing").modal("show")})),$(".card").removeClass("hidden")}})}function getCurrentMembershipPayList(){let t=JSON.parse(COMM.getCookie("institution_info")).institution_seq,e=CONST.API.INSTITUTION.MEMBERSHIP;$("#current_membership_pay_list").empty(),API.load({url:e.replace("${inst_seq}",t),type:CONST.API_TYPE.GET,success:function(t){$.each(t.value,(function(t,e){let a="",n="";"0"==e.order_type||"1"==e.order_type?(a="approved",n="승인"):"3"==e.order_type?(a="canceled",n="전체 취소"):(a="canceled",n="부분 취소");let i="";"CARD"==e.pay_method?i="신용카드":"BANK"==e.pay_method&&(i="계좌이체");let s="";s=1==e.order_type?"직접 결제":2==e.order_type?"자동 결제":"취소",$("#current_membership_pay_list").append(`<tr data-url="./info_payment_new-info.html" data-order="${e.order_seq}" class="${a}">\n\t\t\t\t\t\t<td>${moment(e.auth_date,"YY-MM-DD hh:mm:ss").format("YYYY-MM-DD HH:mm:ss")}</td>\n\t\t\t\t\t\t<td class="ipsapNo">${e.moid}</td>\n\t\t\t\t\t\t<td>${e.pname} (${moment(e.the_date,"YYYYMM").format("YYYY년 M월")})</td>\n\t\t\t\t\t\t<td class="text-right pRight10">${setComma(e.amount)}</td>\n\t\t\t\t\t\t<td class="text-center">${i} - ${s}</td>\n\t\t\t\t\t\t<td class="text-center"">${n}</td>\n\t\t\t\t\t\t<td class="text-center" data-tid="${e.tid}">\n\t\t\t\t\t\t<button type="button" class="btn btn-primary btn_xxs btn_certification">증명서 발급<i class="far fa-file mLeft5"></i></button>\n\t\t\t\t\t\t</td>\n\t\t\t\t  \t</tr>`)}))},error:function(t){},complete:function(){initDataTable("#datatable"),$(".btn_certification").on("click",(function(t){t.stopImmediatePropagation(),printReceipt($(this).parent().data("tid"))})),setTriggerTrDataUrlOnClick()}})}function printReceipt(t){var e="https://npg.nicepay.co.kr/issue/IssueLoader.do?TID="+t+"&type=0";window.open(e,"popupIssue","toolbar=no,location=no,directories=no,status=yes,menubar=no,scrollbars=yes,resizable=yes,width=420,height=540")}function changeMembership(){let t=$(".changing_membership").find(".membership_name").data("planseq"),e=JSON.parse(COMM.getCookie("institution_info")).institution_seq,a=CONST.API.MEMBERSHIP.CHANGE;API.load({url:a.replace("${inst_seq}",e).replace("${product_seq}",t),type:CONST.API_TYPE.PATCH,success:function(t){},complete:function(){location.reload()}})}function orderAssign(){var t="";t=0==g_membership_fee_status?$("#modal_prepare").find(".modal_membership_price").text().replace("원",""):$("#modal_prepare").find(".modal_payment_price").text().replace("원","");var e=JSON.parse(COMM.getCookie("user_info")).user_seq;let a=JSON.parse(COMM.getCookie("institution_info")).institution_seq;var n=new Object;n.amt=Number(t.replace(/,/g,"")),n.edi_date=getYYYYMMDDHHMMSSfromDate(new Date),n.goods_name=$("#modal_prepare").find(".modal_payment_title").text(),n.product_seq=Number($("#modal_prepare").find(".planseq").attr("value")),n.buyername=$("#buyer_name").val(),n.buyertel=$("#buyer_phone").val().replaceAll("-",""),n.buyeremail=$("#buyer_email").val(),API.load({url:CONST.API.ORDERS.REQ_ASSIGN,type:CONST.API_TYPE.POST,data:n,success:function(t){$("#modal_prepare").find("input[name=GoodsName]").attr("value",t.goods_name),$("#modal_prepare").find("input[name=Amt]").attr("value",n.amt),$("#modal_prepare").find("input[name=MID]").attr("value",t.mid),$("#modal_prepare").find("input[name=EdiDate]").attr("value",t.edi_date),$("#modal_prepare").find("input[name=Moid]").attr("value",t.moid),$("#modal_prepare").find("input[name=SignData]").attr("value",t.sign_data),$("#modal_prepare").find("input[name=ReqReserved]").attr("value",`{"product_seq":${n.product_seq},"user_seq":${e}, "institution_seq":${a}}`),$("#modal_prepare").find("input[name=BuyerName]").attr("value",n.buyername),$("#modal_prepare").find("input[name=BuyerTel]").attr("value",n.buyertel),$("#modal_prepare").find("input[name=BuyerEmail]").attr("value",n.buyeremail),nicepayStart()},error:function(t){}})}function nicepayStart(){goPay(document.payForm)}function nicepaySubmit(){var t=$("form[name=payForm]").serialize();$.ajax({url:"https://www.ipsap.co.kr:7375/api/v1.0/orders",type:"POST",enctype:"application/x-www-form-urlencoded",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:t,success:function(t){location.reload()},error:function(t){alert("다음과 같은 이유로 결제에 실패하였습니다. 처음부터 다시 결제를 시도해 주세요. ["+t.responseJSON.em+"]"),location.reload()}})}function nicepayClose(){alert("결제가 취소 되었습니다")}function billingAssign(){API.load({url:CONST.API.BILLING.REQ_ASSIGN,type:CONST.API_TYPE.GET,success:function(t){keyRequest(t.mid)},error:function(t){alert("다음과 같은 이유로 결제에 실패하였습니다. 처음부터 다시 결제를 시도해 주세요. ["+t.responseJSON.em+"]"),location.reload()}})}function keyRequest(t){let e=JSON.parse(COMM.getCookie("user_info")).user_seq,a=JSON.parse(COMM.getCookie("institution_info")).institution_seq;document.tranMgr.action="https://web.nicepay.co.kr/billing/step1.jsp";var n="left="+(screen.Width-545)/2+",top="+(screen.Height-573)/2+",width=553,height=610,toolbar=no,location=no,directories=no,status=yes,menubar=no,scrollbars=no,resizable=no";window.open("","billWindow",n);document.tranMgr.target="billWindow",$("#modal_billing").find("input[name=MID]").attr("value",t),$("#modal_billing").find("input[name=GoodsName]").attr("value","정기결제 등록"),$("#modal_billing").find("input[name=BuyerName]").attr("value",$("#buyer_name_billing").val()),$("#modal_billing").find("input[name=BuyerTel]").attr("value",$("#buyer_phone_billing").val().replaceAll("-","")),$("#modal_billing").find("input[name=BuyerEmail]").attr("value",$("#buyer_email_billing").val()),$("#modal_billing").find("input[name=ReturnUrl]").attr("value","https://www.ipsap.co.kr:7375/api/v1.0/billing-key"),$("#modal_billing").find("input[name=MallReserved]").attr("value",`${a},${e}`),$("#modal_billing").find("input[name=PayMethod]").attr("value","BILL"),$("#modal_billing").find("input[name=SecureKeypadYN]").attr("value","Y"),$("#modal_billing").find("input[name=CharSet]").attr("value","utf-8"),document.tranMgr.submit()}function changeMethod(){let t=JSON.parse(COMM.getCookie("institution_info")).institution_seq,e=CONST.API.MEMBERSHIP.PAYMENT_SETTING;API.load({url:e.replace("${inst_seq}",t),type:CONST.API_TYPE.PATCH,success:function(t){},complete:function(){location.reload()}})}function calculateRefundAmt(){API.load({url:CONST.API.MEMBERSHIP.REQ_REFUND_AMT,type:CONST.API_TYPE.GET,success:function(t){$(".refund_amt").text(setComma(t.total_amt))},complete:function(){$("#modal_break_2").modal("show")}})}function comfirmBreak(){API.load({url:CONST.API.MEMBERSHIP.CANCEL,type:CONST.API_TYPE.DELETE,success:function(t){},error:function(t){},complete:function(){$("#result_modal").modal("show")}})}"undefined"==typeof ipsap_common_js&&document.write("<script src='/assets/js/ipsap/ipsap_common.js'><\/script>"),"undefined"==typeof api_js&&document.write("<script src='/assets/js/common/api.js'><\/script>"),"undefined"==typeof const_js&&document.write("<script src='/assets/js/common/const.js'><\/script>"),"undefined"==typeof date_utils_js&&document.write("<script src='/assets/js/common/util/date_utils.js'><\/script>"),$(document).ready((function(){IPSAP.DEMO_MODE?$(".card").removeClass("hidden"):(getUsingPlanInfo(),getCurrentMembershipPayList());let t=$("#cart, #cart_change, #pay_method");t.on({"show.bs.collapse":e=>{let a=$(e.currentTarget);t.not(a).collapse("hide")}}),$(".showDetail_trigger").on({click:t=>{let e=$(t.currentTarget),a=$(e.data("target")).closest("table");a.hasClass("showDetail")?(e.text("자세히 보기"),a.removeClass("showDetail")):(e.text("간략하게 보기"),a.addClass("showDetail"))}}),$("#is_sameUser").on("change",(function(){if($(this).is(":checked")){var t=JSON.parse(COMM.getCookie("user_info")).name,e=JSON.parse(COMM.getCookie("user_info")).phoneno,a=JSON.parse(COMM.getCookie("user_info")).email;$("#buyer_name").val(t),$("#buyer_phone").val(e.replace(/(^02.{0}|^01.{1}|[0-9]{3})([0-9]+)([0-9]{4})/,"$1-$2-$3")),$("#buyer_email").val(a),$("#buyer_name").prop("readonly",!0),$("#buyer_phone").prop("readonly",!0),$("#buyer_email").prop("readonly",!0)}else $("#buyer_name").val(""),$("#buyer_phone").val(""),$("#buyer_email").val(""),$("#buyer_name").prop("readonly",!1),$("#buyer_phone").prop("readonly",!1),$("#buyer_email").prop("readonly",!1)})),$("#is_sameUser_billing").on("change",(function(){if($(this).is(":checked")){var t=JSON.parse(COMM.getCookie("user_info")).name,e=JSON.parse(COMM.getCookie("user_info")).phoneno,a=JSON.parse(COMM.getCookie("user_info")).email;$("#buyer_name_billing").val(t),$("#buyer_phone_billing").val(e.replace(/(^02.{0}|^01.{1}|[0-9]{3})([0-9]+)([0-9]{4})/,"$1-$2-$3")),$("#buyer_email_billing").val(a),$("#buyer_name_billing").prop("readonly",!0),$("#buyer_phone_billing").prop("readonly",!0),$("#buyer_email_billing").prop("readonly",!0)}else $("#buyer_name_billing").val(""),$("#buyer_phone_billing").val(""),$("#buyer_email_billing").val(""),$("#buyer_name_billing").prop("readonly",!1),$("#buyer_phone_billing").prop("readonly",!1),$("#buyer_email_billing").prop("readonly",!1)})),$("#btn_req_refund").on("click",(function(t){t.stopPropagation(),calculateRefundAmt()})),$("#comfirm_break").on("click",(function(t){comfirmBreak()}))})),$(document).on("click",".purchase_item",(function(){var t=$(this).closest("tr").data("planseq"),e=$(this).closest("tr").find(".plan_name").text(),a=$(this).closest("tr").find(".membership_price").text().replace("원",""),n=$(this).closest("tr").find(".plan_price").text().replace("원",""),i=JSON.parse(COMM.getCookie("user_info")).name,s=JSON.parse(COMM.getCookie("user_info")).phoneno,l=JSON.parse(COMM.getCookie("user_info")).email;$("#modal_prepare").find(".planseq").attr("value",t),$("#modal_prepare").find(".modal_payment_title").text(e),$("#modal_prepare").find(".modal_membership_price").text(a),$("#modal_prepare").find(".modal_payment_price").text(n),0==g_membership_fee_status?($("#price_div").children().eq(2).css("display","none"),$("#price_div").children().eq(3).css("display","none")):($("#price_div").children().eq(0).css("display","none"),$("#price_div").children().eq(1).css("display","none")),$("#buyer_name").val(i),$("#buyer_phone").val(s.replace(/(^02.{0}|^01.{1}|[0-9]{3})([0-9]+)([0-9]{4})/,"$1-$2-$3")),$("#buyer_email").val(l),$("#modal_prepare").modal("show")}));